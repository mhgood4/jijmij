<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BTC Position Tracker</title>
  <style>
    :root{--bg:#0a0a0a;--panel:#0f0f10;--muted:#b9b9b9;--text:#f5f5f5;--accent:#f59e0b;--good:#22c55e;--bad:#ef4444;--border:#2a2a2a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    header{padding:20px 16px;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    main{max-width:1100px;margin:20px auto;padding:0 12px 60px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .grow{flex:1}
    .kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:16px}
    .kpi .item{padding:12px;background:#0b1220;border:1px solid var(--border);border-radius:10px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:18px;margin-top:4px;font-weight:700}
    .price{color:var(--accent)}
    table{width:100%;border:1px solid var(--border);border-radius:12px;border-collapse:collapse;min-width:1000px}
    thead th{background:#0b1220;border:1px solid var(--border);padding:10px;font-weight:600}
    td,th{padding:8px;border:1px solid var(--border);text-align:right;font-size:12px}
    td:first-child,th:first-child{text-align:left}
    tr.buy{background:rgba(34,197,94,0.05)}
    tr.sell{background:rgba(239,68,68,0.05)}
    input{width:100%;padding:6px;background:#0b1220;border:1px solid var(--border);border-radius:6px;color:var(--text);font:inherit;box-sizing:border-box}
    select{width:100%;padding:6px;background:#0b1220;border:1px solid var(--border);border-radius:6px;color:var(--text);font:inherit}
    button{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 12px;cursor:pointer;font-size:13px}
    button.primary{background:var(--accent);color:#111;font-weight:600}
    .profit-pos{color:var(--good)}
    .profit-neg{color:var(--bad)}
    .btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .cards{display:none}
    .cardItem{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0}
    .cardItem.new-row{border-left:4px solid var(--accent);background:rgba(245,158,11,0.1)}
    .cardItem.buy{background:rgba(34,197,94,0.05)}
    .cardItem.sell{background:rgba(239,68,68,0.05)}
    @media (max-width:600px){
      table{display:none}
      .cards{display:block}
      .kpi{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <header>
    <h1>BTC Position Tracker</h1>
    <div class="sub">Track buy/sell transactions with profit calculation</div>
  </header>
  <main>
    <div class="row">
      <div class="card grow">
        <div class="kpi">
          <div class="item"><div class="label">Live BTC Price</div><div class="value price" id="livePrice">-</div></div>
          <div class="item"><div class="label">Total BTC</div><div class="value" id="kpiBtc">-</div></div>
          <div class="item"><div class="label">Total Invested</div><div class="value" id="kpiCost">-</div></div>
          <div class="item"><div class="label">Portfolio Value</div><div class="value" id="kpiValue">-</div></div>
          <div class="item"><div class="label">Unrealized P/L</div><div class="value" id="kpiPL">-</div></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <div class="card grow">
        <div class="btnbar">
          <button class="primary" id="btnAdd">Add Row</button>
          <button id="btnReset">Reset</button>
          <button id="btnRefresh" style="background:var(--accent);color:#000">Refresh Price</button>
          <button id="btnShare">Share</button>
        </div>
        <div style="overflow:auto">
          <table id="tbl">
            <thead><tr><th>Date</th><th>Type</th><th>BTC</th><th>USD</th><th>Linked To</th><th>Entry</th><th>P/L</th><th>ROI</th><th></th></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div id="cards" class="cards"></div>
      </div>
    </div>
  </main>

  <script>
    const INITIAL = [
      {date:"2023-01-20", type:"buy", btc:0.0151, usd_cost:347.30, cost_basis:0},
      {date:"2024-03-19", type:"buy", btc:0.004574, usd_cost:301.84, cost_basis:0},
      {date:"2024-12-11", type:"buy", btc:0.010222, usd_cost:1000.00, cost_basis:0},
      {date:"2024-12-19", type:"buy", btc:0.009125, usd_cost:900.00, cost_basis:0},
      {date:"2025-02-02", type:"buy", btc:0.005723, usd_cost:500.50, cost_basis:0},
      {date:"2025-02-04", type:"buy", btc:0.006731, usd_cost:559.00, cost_basis:0},
      {date:"2025-11-04", type:"buy", btc:0.010520, usd_cost:1078.92, cost_basis:0},
      {date:"2025-11-04", type:"buy", btc:0.005280, usd_cost:538.50, cost_basis:0},
      {date:"2025-11-04", type:"buy", btc:0.002580, usd_cost:262.00, cost_basis:0},
      {date:"2025-11-04", type:"buy", btc:0.004960, usd_cost:500.00, cost_basis:0},
      {date:"2025-11-04", type:"buy", btc:0.005000, usd_cost:500.00, cost_basis:0},
      {date:"2025-11-05", type:"buy", btc:0.0098, usd_cost:1000.00, cost_basis:0},
      {date:"2025-11-10", type:"sell", btc:0.00704, usd_cost:750.00, cost_basis:630, linked_to:11}
    ];

    let lots = JSON.parse(localStorage.getItem('btc_lots') || 'null') || JSON.parse(JSON.stringify(INITIAL));
    let live = {price:NaN, provider:''};
    let newRowIdx = -1;

    function save() {localStorage.setItem('btc_lots', JSON.stringify(lots));}
    function fmt(n, d) {return Number.isFinite(n) ? n.toLocaleString(undefined, {minimumFractionDigits:d, maximumFractionDigits:d}) : '-';}

    async function getLivePrice() {
      try {
        let r = await fetch('https://api.coinbase.com/v2/prices/spot?currency=USD');
        if (r.ok) {let j = await r.json(); let p = parseFloat(j.data.amount); if (Number.isFinite(p)) return {price:p, provider:'Coinbase'};}
      } catch(e) {}
      try {
        let r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        if (r.ok) {let j = await r.json(); let p = parseFloat(j.price); if (Number.isFinite(p)) return {price:p, provider:'Binance'};}
      } catch(e) {}
      return {price:NaN, provider:''};
    }

    function renderTable() {
      const tb = document.getElementById('tbody');
      const cards = document.getElementById('cards');
      tb.innerHTML = '';
      if (cards) cards.innerHTML = '';

      const price = live.price;
      let totBtc = 0, totCost = 0, totValue = 0;

      if (newRowIdx >= 0) {
        const lot = lots[0];
        const tr = document.createElement('tr');
        tr.className = 'new-row';

        const td1 = document.createElement('td');
        const in1 = document.createElement('input');
        in1.type = 'date';
        in1.value = (lot.date || '').slice(0, 10);
        in1.addEventListener('change', () => {lot.date = in1.value; save();});
        td1.appendChild(in1);

        const td2 = document.createElement('td');
        const sel = document.createElement('select');
        sel.innerHTML = '<option value="buy">BUY</option><option value="sell">SELL</option>';
        sel.value = lot.type || 'buy';
        sel.addEventListener('change', () => {lot.type = sel.value; save();});
        td2.appendChild(sel);

        const td3 = document.createElement('td');
        const in2 = document.createElement('input');
        in2.type = 'text';
        in2.inputMode = 'decimal';
        in2.addEventListener('change', () => {lot.btc = parseFloat(in2.value) || 0; save(); renderTable();});
        td3.appendChild(in2);

        const td4 = document.createElement('td');
        const in3 = document.createElement('input');
        in3.type = 'text';
        in3.inputMode = 'decimal';
        in3.addEventListener('change', () => {lot.usd_cost = parseFloat(in3.value) || 0; save(); renderTable();});
        td4.appendChild(in3);

        const td5 = document.createElement('td');
        const in4 = document.createElement('input');
        in4.type = 'text';
        in4.value = lot.linked_to ? 'Links to BUY #' + lot.linked_to : 'N/A';
        in4.readOnly = true;
        td5.appendChild(in4);

        const td6 = document.createElement('td');
        td6.textContent = '-';
        const td7 = document.createElement('td');
        td7.textContent = '-';
        const td8 = document.createElement('td');
        td8.textContent = '-';
        const td9 = document.createElement('td');
        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.style.background = 'var(--accent)';
        saveBtn.style.color = '#111';
        saveBtn.addEventListener('click', () => {newRowIdx = -1; renderTable();});
        td9.appendChild(saveBtn);

        tr.append(td1, td2, td3, td4, td5, td6, td7, td8, td9);
        tb.appendChild(tr);
      }

      const sorted = [...lots].sort((a, b) => new Date(b.date || '0') - new Date(a.date || '0'));
      
      sorted.forEach(lot => {
        if (newRowIdx >= 0 && lots[0] === lot) return;
        
        const tr = document.createElement('tr');
        tr.className = lot.type || 'buy';

        const td1 = document.createElement('td');
        const in1 = document.createElement('input');
        in1.type = 'date';
        in1.value = (lot.date || '').slice(0, 10);
        in1.addEventListener('change', () => {lot.date = in1.value; save(); renderTable();});
        td1.appendChild(in1);

        const td2 = document.createElement('td');
        const sel = document.createElement('select');
        sel.innerHTML = '<option value="buy">BUY</option><option value="sell">SELL</option>';
        sel.value = lot.type || 'buy';
        sel.addEventListener('change', () => {lot.type = sel.value; save(); renderTable();});
        td2.appendChild(sel);

        const td3 = document.createElement('td');
        const in2 = document.createElement('input');
        in2.type = 'text';
        in2.inputMode = 'decimal';
        in2.value = String(lot.btc || 0);
        in2.addEventListener('change', () => {lot.btc = parseFloat(in2.value) || 0; save(); renderTable();});
        td3.appendChild(in2);

        const td4 = document.createElement('td');
        const in3 = document.createElement('input');
        in3.type = 'text';
        in3.inputMode = 'decimal';
        in3.value = String(lot.usd_cost || 0);
        in3.addEventListener('change', () => {lot.usd_cost = parseFloat(in3.value) || 0; save(); renderTable();});
        td4.appendChild(in3);

        const td5 = document.createElement('td');
        const in4 = document.createElement('input');
        in4.type = 'text';
        in4.value = lot.linked_to ? 'Links to BUY #' + lot.linked_to : 'N/A';
        in4.readOnly = true;
        td5.appendChild(in4);

        const imp = (lot.btc > 0) ? (lot.usd_cost / lot.btc) : NaN;
        let pl, roi;
        
        if (lot.type === 'sell') {
          const linkedBuy = lots.find((l, idx) => idx === (lot.linked_to - 1));
          const costBasis = linkedBuy ? (linkedBuy.usd_cost / linkedBuy.btc) * lot.btc : 0;
          pl = (lot.usd_cost || 0) - costBasis;
          roi = (costBasis > 0) ? (pl / costBasis * 100) : NaN;
        } else {
          const val = Number.isFinite(price) ? (lot.btc * price) : NaN;
          pl = Number.isFinite(val) ? (val - lot.usd_cost) : NaN;
          roi = (lot.usd_cost > 0 && Number.isFinite(pl)) ? (pl / lot.usd_cost * 100) : NaN;
        }

        const td6 = document.createElement('td');
        td6.textContent = fmt(imp, 2);
        const td7 = document.createElement('td');
        td7.textContent = fmt(pl, 2);
        td7.className = Number.isFinite(pl) ? (pl >= 0 ? 'profit-pos' : 'profit-neg') : '';
        const td8 = document.createElement('td');
        td8.textContent = Number.isFinite(roi) ? fmt(roi, 2) + '%' : '-';
        td8.className = Number.isFinite(roi) ? (roi >= 0 ? 'profit-pos' : 'profit-neg') : '';

        const td9 = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = 'X';
        delBtn.addEventListener('click', () => {
          if (confirm('Delete ' + lot.date + '?')) {
            lots.splice(lots.indexOf(lot), 1);
            save();
            renderTable();
          }
        });
        td9.appendChild(delBtn);

        tr.append(td1, td2, td3, td4, td5, td6, td7, td8, td9);
        tb.appendChild(tr);

        if (lot.type === 'buy') {
          totBtc += Number(lot.btc) || 0;
          totCost += Number(lot.usd_cost) || 0;
          if (Number.isFinite(price)) totValue += (Number(lot.btc) || 0) * price;
        } else {
          totBtc -= Number(lot.btc) || 0;
        }
      });

      const avg = (totBtc > 0) ? (totCost / totBtc) : NaN;

      document.getElementById('kpiBtc').textContent = fmt(totBtc, 6);
      document.getElementById('kpiCost').textContent = fmt(totCost, 2);
      document.getElementById('kpiValue').textContent = fmt(totValue, 2);
      document.getElementById('kpiPL').textContent = fmt(totValue - totCost, 2);
    }

    async function refreshPrice() {
      live = await getLivePrice();
      document.getElementById('livePrice').textContent = fmt(live.price, 0);
      renderTable();
    }

    document.getElementById('btnAdd').addEventListener('click', () => {
      lots.unshift({date:new Date().toISOString().slice(0, 10), type:'buy', btc:0, usd_cost:0, cost_basis:0});
      newRowIdx = 0;
      save();
      renderTable();
    });

    document.getElementById('btnReset').addEventListener('click', () => {
      lots = JSON.parse(JSON.stringify(INITIAL));
      newRowIdx = -1;
      save();
      renderTable();
    });

    document.getElementById('btnRefresh').addEventListener('click', refreshPrice);

    document.getElementById('btnShare').addEventListener('click', () => {
      let totBtc = 0, totCost = 0, totValue = 0;
      lots.forEach(l => {
        if (l.type === 'buy') {
          totBtc += Number(l.btc) || 0;
          totCost += Number(l.usd_cost) || 0;
          if (Number.isFinite(live.price)) totValue += (Number(l.btc) || 0) * live.price;
        } else {
          totBtc -= Number(l.btc) || 0;
        }
      });
      const text = 'BTC: ' + fmt(totBtc, 6) + '\nInvested: ' + fmt(totCost, 2) + '\nValue: ' + fmt(totValue, 2) + '\nP/L: ' + fmt(totValue - totCost, 2);
      if (navigator.share) navigator.share({title:'BTC Tracker', text}).catch(() => {});
      else {navigator.clipboard.writeText(text); alert('Copied');}
    });

    renderTable();
    refreshPrice();
    setInterval(refreshPrice, 60000);
  </script>
</body>
</html>
